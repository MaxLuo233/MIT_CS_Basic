# High-Level
## 操作系统、网络系统
---

### 操作系统
> ### 操作系统的设计理念灵魂：通过模块化和抽象化设计确保程序之间的隔离、交互、有序进行
> 模块化设计的重要性在于使得系统更容易理解、管理、改变、改进。
>
> 模块化设计通过抽象设计减少模块之间的耦合，通过命名系统实现有层次地交互。
>
> ### 操作系统通过虚拟化（virtulization）和抽象（abstractation）确保在单机上的模块化设计
> a. 程序不应该可以访问和修改其他程序的内存（隔离） => virtual memory
>
> 操作系统对硬件的不同部分进行虚拟化，让程序以为自己访问的是完整的物理硬件。
>
> 虚拟内存让程序寻址整个地址空间，MMU 负责将虚拟地址转换为物理地址。
>
> 通过页表实现分页映射，虚拟地址前 p 位作为页 index，后 q 位作为页内偏移，减少映射表的存储空间。
> 
> b. 程序之间应该可以互相通信（通信机制） => 有界缓冲区与锁同步
> 
> 操作系统的互斥锁（Mutex，互斥量）是一种同步机制，用于保护共享资源，以防止多个线程同时访问和修改共享资源而导致数据不一致或竞态条件问题。
>
> c. 程序应该可以和其他程序共享 CPU => 虚拟化CPU（抢占式多线程 threads）
> 
> 线程thread：一个虚拟的处理器（包装了一个程序的运行状态） 线程切换：将当前程序的运行状态换出，将另一个程序的运行状态换入（suspend/resume，或context switching）
>
> 线程主动放弃CPU：yield()
放弃当前线程的CPU执行权，保存当前线程的信息（栈、页表寄存器、callee-saved registers，不需要保存pc，因为在栈中的return address已经有），找到另一个可以运行的线程，并恢复新线程的运行状态（恢复栈指针、页表、callee-saved registers，ret指令返回到新线程之前yield后的位置）
>
>条件变量（condition variable）
程序可以等待（wait）一个条件（condition）的发生，并且在该条件发生的时候收到通知。 另一进程可以在一个条件变为真的时候，使用 notify() 通知所有正在等待该条件的进程。
>
>### 虚拟机
> 操作系统通过模块化实现单机上程序的隔离，虚拟机实现单机撒花姑娘操作系统的隔离
>
> 虚拟化CPU:
用户系统直接在真实 CPU 上运行指令。问题：特权指令的处理
VMM 负责处理特权指令，当子系统执行特权指令的时候，会引发宿主系统的中断，并允许宿主系统处理这一特权指令。
>
> 虚拟化内存:
现代 CPU 含有对虚拟化的支持，CPU 同时知道客户系统以及宿主系统的页表的存在，并会在客户系统尝试访问内存时，依次查询两个页表。
>
>

### 网络系统
>分层 layering 与分级 hierarchy
>
>可扩张性 scalability：如果确保模块性 modularity 是 6.033 第一部分的主题，则可扩张性则是第二部分的主题。
>
>效率/性能：性能需求影响网络的设计
>
>应用的多样性：有的关心吞吐（如下载）、有的关心延迟（如游戏），有的都在乎，有的需要可靠性，有的不需要……等等。我们需要构建一个可以支撑所有这些需求的网络
>
>端到端争议：互联网的什么功能应该由那些部分来实现？（端点？交换机？etc.）
>
>### 路由：让每个交换机知道，任何两节点之间的minimum-cost路径
>中心化的路由表构建协议无法scale，只考虑分布式，即节点独立获取自己所需要的信息，然后独自构建它们自己的路由表。
>
>链路状态路由协议，矢量路径路由协议的大开销、infinity问题无法scale到Internet级别；Internet实际由小网络内独立建立路由+BGP粘合小网络组成。
>
>BGP和 distance vector routing 相似，但是advertisement中包含了整个完整路径。overhead增大，但仍然比link state routing要小。汇聚时间减小（由于整合的时候有完整路径，能避免routing loop，可以避免在出现节点故障时某些路由来回广播直到infinity的问题）
>
>常见的AS关系
客户/运营商：客户付费获得网络服务（home）
peers：互相提供给对方自己路由表的子集，增加互联。互利行为。（比如电信和移动网的互联。早期互联网的peer互联比较匮乏，稳定性也比较差，所以游戏会有不同线路的服务器）
>
>BGP 是一个应用层协议 application layer protocol。 BGP 策略一般由人设置，所以经常可以看到误配置导致的大规模中断（如2021年10月的 facebook outage）
BGP basically relies on the honor system（BGP并不安全，BGP spoofing，AS对 BGP 公告的绝对信任） （2008年巴基斯坦ISP公告伪造的Youtube线路导致世界Youtube断连）
>
>### 可靠传输
>TCP拥塞控制：通过控制滑动窗口大小，方式：AIMD（线性增加，倍数回退）
>
>TCP支持slow start（实际上是快启动，启动阶段指数放大window size，直到出现丢包为止开始回退。相比一开始就跑大窗口来说是“slow start”）
快速重传/快速恢复（有时通过重复ACK可以直接推断某个包丢失，则可以直接开始重传而不需要等待超时）
>
>
>### 链路带宽资源分配
>最基本的队列管理策略：如果包到达时队列已满，则丢弃；否则则将其加入队列。
缺点：同时检测到丢包，同时回退，导致链路从过载突然变成欠载，导致链路利用率下降
>
>主动队列管理（active queue management）方案：在队列未完全满之前就开始随机丢包，以提前给TCP发送拥塞正在形成的信号。主动丢包概率与一段时间内的平均队列长度正相关。这些主动队列管理模式的一个问题是，相比被动拥塞控制，它们更加复杂。包含了许多与网络状态相关的需要设置的参数，而网络是不断变化的。这些参数如果设置不当，有时候会使得效果更差。
>
>流量区分方案：将不同类型的流量放到不同的队列中，并在队列上做特殊处理。
>
>流量调度：基于延迟的调度、基于带宽的调度。
>
>轮询、带权轮询（Weighted Round-robin）
轮流准许每个队列发送数据。带权轮询可以用于手动指定优先级（或者在按包轮询的实现中，可以使用权来将其转换为等数据量）。缺点：如果需要实现按数据量分配的话，需要提前知道或者测量计算出某队列的平均包大小，才能生成适合的权用于确定每轮每个队列应该传输多少个包。
>
>deficit round-robin赤字轮询: 不同的队列可以积累“积分”用于下一轮的发送
>
